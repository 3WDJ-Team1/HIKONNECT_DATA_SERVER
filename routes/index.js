/**
 * 
 */
var express = require('express');
var router = express.Router();
var fs = require('fs');
var proj4 = require('proj4');
var net = require('net');

/* GET home page. */
router.get('/', function(req, res, next) {
  res.render('index', { title: 'Express' });
});

/**
 * @function      This function returns hiking route's coordinates converted from 
 *                TM projection to GRS80 Projection(degrees).
 *                HTTP request URL = host:3000/paths/{mntCode}/{fid}
 * 
 * @param String  req.params.mntCode  Mountain's serial code.
 * @param String  req.params.fid      Feature's ID.
 * 
 * @const String  KTM_PROJ            KTM Projection(Korean) Setting for converting.
 * @const String  EPSG4019            GRS80 Projection setting for converting.  
 * 
 * @var   Array   coordinateFilePath  Coordinate file path in local storage.
 * @var   Array   coordinateFiles     Coordinate file list in local storage.
 * @var   String  mntFileName         Selected file name.
 * @var   Array   coordinateFile      JSON Object in local storage.
 *                                    This contains short description that hiking path.
 * @var   Array   mntPaths            Coordinates list in local file.
 * 
 * @return  null
 *          HTTP Response = String    The String is formatted by JSON syntax.
 */
router.get('/paths/:mntCode/:fid?', function(req, res, next) {
  // TM Projectrion Setting (Korean)
  const KTM_PROJ = '+proj=tmerc +lat_0=38 +lon_0=127 +k=1 +x_0=200000 +y_0=600000 +ellps=GRS80 +units=m +no_defs';

  // GRS80 Projection Setting
  const EPSG4019 = '+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs';

  var mntCode = req.params.mntCode;
  var fid = req.params.fid;

  // Hiking paths directory in local
  let coordinateFilePath = `public/mountain/${mntCode}_geojson`;

  // Hiking path files path in local
  fs.readdir(coordinateFilePath, (err, coordinateFiles) => {
    if (coordinateFiles == undefined) {
      return res.sendStatus(404);
    }

    coordinateFiles.forEach((fileName, idx, arr) => {
      let mntFileName;

      if (fileName.match(/^PMNTN_SPOT_/) || fileName.match(/^PMNTN_SAFE_SPOT_/)) {
        return;
      }
      mntFileName = fileName;

      fs.readFile(
        `${coordinateFilePath}/${mntFileName}`, 
        {encoding: 'utf8'}, 
        (err, coordinateFile) => {
          // Hiking paths in file
          var mntPaths = JSON.parse(coordinateFile)['features'];

          Promise.all(mntPaths.map((data) => {
              let idx = data['attributes']['fid'];

              var routePaths = data['geometry']['paths'][0];

              routePaths.map((data, idx) => {
                let coordinate = proj4(KTM_PROJ, EPSG4019).forward(data);
                
                data = {
                  lat: coordinate[1],
                  lng: coordinate[0],
                }
                routePaths[idx] = data;
              });
          }))
          .then(() => {
            if (fid == undefined) {
              return res.json(mntPaths);
            } else if (mntPaths[fid] != undefined) {
              return res.json(mntPaths[fid]);
            } else {
              return res.sendStatus(404);
            }
          });
      });
    });
  });
});

/**
 * 
 */
router.get('/dummy/school', (req, res, next) => {
  const DUMMY_DATA = [
    {"attributes":{"FID":2,"PMNTN_SN":32658,"MNTN_CODE":"438001301","MNTN_NM":"소백산_비로봉","PMNTN_NM":"천동리구간","PMNTN_MAIN":" ","PMNTN_LT":9.21,"PMNTN_DFFL":"쉬움","PMNTN_UPPL":345,"PMNTN_GODN":242,"PMNTN_MTRQ":" ","PMNTN_CNRL":" ","PMNTN_CLS_":" ","PMNTN_RISK":" ","PMNTN_RECO":" ","DATA_STDR_":"2016-12-31","MNTN_ID":"438001301"},"geometry":{"paths":[[{"lat":36.934151655741104,"lng":128.4606656586206},{"lat":36.93420077356173,"lng":128.46053914708668},{"lat":36.934187171190764,"lng":128.46048052671182},{"lat":36.934157573263654,"lng":128.46036910095927},{"lat":36.93414648204102,"lng":128.46029005478212},{"lat":36.93415870739706,"lng":128.46022883604346},{"lat":36.93420590767789,"lng":128.46019435840682},{"lat":36.93426474264398,"lng":128.46017171663146},{"lat":36.934323577605724,"lng":128.4601490748222},{"lat":36.93434502088519,"lng":128.4601084289761},{"lat":36.934336653261056,"lng":128.45998265697855},{"lat":36.93433563003477,"lng":128.45981898475625},{"lat":36.934413686448615,"lng":128.4591594804094},{"lat":36.93449027689061,"lng":128.4586811510324},{"lat":36.93453486046295,"lng":128.45838945977917},{"lat":36.934547591601266,"lng":128.45797462454254},{"lat":36.93459785473753,"lng":128.45756025872586},{"lat":36.93460162351976,"lng":128.45709270590189},{"lat":36.93459989845884,"lng":128.45672444934428},{"lat":36.93463664689823,"lng":128.45623977348163},{"lat":36.93465203941108,"lng":128.45607630568082},{"lat":36.93463885822894,"lng":128.45596508596284},{"lat":36.934602006856494,"lng":128.45587987316813},{"lat":36.9345277865751,"lng":128.4557737363047},{"lat":36.93433836129495,"lng":128.45569830854208},{"lat":36.934078772311736,"lng":128.4555957027967},{"lat":36.93386893958282,"lng":128.45543234699986},{"lat":36.93365176352743,"lng":128.45530689249125},{"lat":36.9335047510764,"lng":128.45520861645136},{"lat":36.93332123897073,"lng":128.454981297462},{"lat":36.93318391501406,"lng":128.4548451515519},{"lat":36.933035167036046,"lng":128.45467087191093},{"lat":36.932888764631954,"lng":128.45449662220182},{"lat":36.93280133675377,"lng":128.45428219441902},{"lat":36.9327553120375,"lng":128.45417056825917},{"lat":36.93271151568917,"lng":128.45407358215115},{"lat":36.93259267573761,"lng":128.45397273842238},{"lat":36.932293722019125,"lng":128.45380535735063},{"lat":36.93204832356596,"lng":128.4536883257009},{"lat":36.93186382307963,"lng":128.45358374306224},{"lat":36.931686500771775,"lng":128.453461716016},{"lat":36.931442133886286,"lng":128.45321611455842},{"lat":36.93132446552437,"lng":128.45296916967365},{"lat":36.931180875141415,"lng":128.45273651476091},{"lat":36.931105102884466,"lng":128.4525310059304},{"lat":36.93109517794152,"lng":128.4523058601579},{"lat":36.93108999110945,"lng":128.45207492863858},{"lat":36.93107697003401,"lng":128.45194326018995},{"lat":36.93105217274902,"lng":128.45181729008442},{"lat":36.9310368289548,"lng":128.45168267049894},{"lat":36.93103077474662,"lng":128.45155985590492},{"lat":36.93102758121722,"lng":128.45137278486146},{"lat":36.93109096030467,"lng":128.45107549113004},{"lat":36.931208363294765,"lng":128.45077010082005},{"lat":36.931386734133824,"lng":128.4504683889899},{"lat":36.931437540127256,"lng":128.45027614273104},{"lat":36.931438405128006,"lng":128.45016802538248},{"lat":36.93140872727438,"lng":128.45006537369815},{"lat":36.93134838971709,"lng":128.44998279823193},{"lat":36.93124814933276,"lng":128.44990265009017},{"lat":36.93108429059576,"lng":128.44985678115654},{"lat":36.93099800836114,"lng":128.4497914184748},{"lat":36.93082138288827,"lng":128.4495817395295},{"lat":36.93072432898036,"lng":128.44939642727212},{"lat":36.93069662259412,"lng":128.44934055893552},{"lat":36.93064346217357,"lng":128.4492405397166},{"lat":36.93057653014148,"lng":128.44910235935174},{"lat":36.930530663880575,"lng":128.4489702850751},{"lat":36.93046666094404,"lng":128.44875908285744},{"lat":36.93041408348415,"lng":128.44858601301658},{"lat":36.9303050187418,"lng":128.44843562224958},{"lat":36.93019119211364,"lng":128.44829393992313},{"lat":36.92997292172049,"lng":128.44801069274183},{"lat":36.92983336018308,"lng":128.44785992604676},{"lat":36.929665345146304,"lng":128.44774679771967},{"lat":36.92955435305935,"lng":128.44754378420592},{"lat":36.92949696554383,"lng":128.447385269268},{"lat":36.92945815817649,"lng":128.44725036292215},{"lat":36.929450475795505,"lng":128.44703693955358},{"lat":36.92945682154083,"lng":128.4468295343446},{"lat":36.929489576756716,"lng":128.44654647569078},{"lat":36.92947176466095,"lng":128.44642644087662},{"lat":36.929414817946686,"lng":128.44621240859993},{"lat":36.929322054680945,"lng":128.4460768361502},{"lat":36.92919412677061,"lng":128.44593790720504},{"lat":36.929009805202035,"lng":128.44580997113732},{"lat":36.928792734631976,"lng":128.44566994200915},{"lat":36.928603674518364,"lng":128.44554779329548},{"lat":36.92848814966167,"lng":128.44532427392576},{"lat":36.92838823387503,"lng":128.44490807841186},{"lat":36.92835451163064,"lng":128.44442841083125},{"lat":36.928340111576674,"lng":128.44387884757458},{"lat":36.9283669595555,"lng":128.44345252791103},{"lat":36.928406442601045,"lng":128.44320754411095},{"lat":36.928487964904534,"lng":128.44298645604053},{"lat":36.92886157851198,"lng":128.4426170059137},{"lat":36.92913067522494,"lng":128.44240991423166},{"lat":36.929206948038775,"lng":128.44225889374962},{"lat":36.929279038848335,"lng":128.44204353089444},{"lat":36.92928493561166,"lng":128.44189164383712},{"lat":36.92928149510538,"lng":128.44173379728548},{"lat":36.92924177151509,"lng":128.44141770032377},{"lat":36.929243207335986,"lng":128.44123653544278},{"lat":36.92923930289718,"lng":128.44113712927327},{"lat":36.92925890321415,"lng":128.4410321674563},{"lat":36.929325420513536,"lng":128.44092778226593},{"lat":36.92947736053307,"lng":128.44070170981968},{"lat":36.92964268109183,"lng":128.44056347030207},{"lat":36.92967245095144,"lng":128.44035927398994},{"lat":36.92951399699968,"lng":128.44022290126625},{"lat":36.92924331190959,"lng":128.44003839406685},{"lat":36.92893564773592,"lng":128.43978329928345},{"lat":36.92880901782417,"lng":128.43977590016226},{"lat":36.92866794285523,"lng":128.43981508017967},{"lat":36.928390114612235,"lng":128.43994024912632},{"lat":36.928319322729735,"lng":128.43999198068283},{"lat":36.92822474850286,"lng":128.44008433175554},{"lat":36.92813904875791,"lng":128.4402410812475},{"lat":36.9280258463034,"lng":128.44031566946728},{"lat":36.92797879041212,"lng":128.44033262498826},{"lat":36.9277012855337,"lng":128.4404168835865},{"lat":36.92761697357325,"lng":128.44039831446653},{"lat":36.92748105280248,"lng":128.44037911144972},{"lat":36.927148589129395,"lng":128.4402932055126},{"lat":36.926881346703595,"lng":128.44026654551809},{"lat":36.92676400768401,"lng":128.44027094879678},{"lat":36.92670269160754,"lng":128.44031110655726},{"lat":36.926650805204325,"lng":128.44034553567656},{"lat":36.926617639365006,"lng":128.44038603909567},{"lat":36.92661736175363,"lng":128.44042110207326},{"lat":36.92664467911798,"lng":128.4405266368316},{"lat":36.9266721815045,"lng":128.44060879632988},{"lat":36.92669480699004,"lng":128.44071427357787},{"lat":36.9266987581199,"lng":128.44080783259133},{"lat":36.926670283835314,"lng":128.44084839348943},{"lat":36.926550259464584,"lng":128.44119173763588},{"lat":36.92632269538997,"lng":128.4414870031625},{"lat":36.92605387820543,"lng":128.4416590280368},{"lat":36.925551355682224,"lng":128.44171713475143},{"lat":36.92533507371682,"lng":128.44177291745743},{"lat":36.92523654781764,"lng":128.44177170551416},{"lat":36.92510034923595,"lng":128.44178756302236},{"lat":36.924874359439485,"lng":128.44188413565666},{"lat":36.92454543000762,"lng":128.44194437581743},{"lat":36.924353394286776,"lng":128.44190110370525},{"lat":36.92411922582276,"lng":128.44184562511762},{"lat":36.923779238990406,"lng":128.44182098827707},{"lat":36.92343639658727,"lng":128.4418606022627},{"lat":36.9234081073105,"lng":128.44187778673083},{"lat":36.9233676021846,"lng":128.44195618447864},{"lat":36.92335043969693,"lng":128.4420494797045},{"lat":36.923302363851235,"lng":128.44219499180392},{"lat":36.92325247509826,"lng":128.44227327379616},{"lat":36.92320541892196,"lng":128.44229022711477},{"lat":36.92316075495676,"lng":128.44230136572043},{"lat":36.92305045340182,"lng":128.44230585239882},{"lat":36.922869567569855,"lng":128.4423357689063},{"lat":36.92263389251206,"lng":128.44247020464397},{"lat":36.922464249038555,"lng":128.44256162184203},{"lat":36.92239150433783,"lng":128.4425636484078},{"lat":36.92206364099539,"lng":128.4424894839181},{"lat":36.92184299147188,"lng":128.44250430012545},{"lat":36.92154478959855,"lng":128.44253569371028},{"lat":36.92120742684466,"lng":128.4424760232821},{"lat":36.92078345280263,"lng":128.4423919116665},{"lat":36.92056744859534,"lng":128.44241262909344},{"lat":36.920445510433375,"lng":128.44240528447838},{"lat":36.92021887093054,"lng":128.4425836564362},{"lat":36.919786402330004,"lng":128.4429786386589},{"lat":36.91937934239437,"lng":128.44342360214375},{"lat":36.91916895992663,"lng":128.44362262237283},{"lat":36.9189188136539,"lng":128.44380654192017},{"lat":36.91862342248279,"lng":128.4440746374546},{"lat":36.91835381190768,"lng":128.4443459707284},{"lat":36.91823152545402,"lng":128.4443824471996},{"lat":36.91797378326418,"lng":128.4443412845391},{"lat":36.917816773499574,"lng":128.44431889541949},{"lat":36.917713160986764,"lng":128.44436728939985},{"lat":36.91734592986375,"lng":128.4445234624473},{"lat":36.917188501967715,"lng":128.4445536610953},{"lat":36.917076063492125,"lng":128.44453182150806},{"lat":36.91694755245977,"lng":128.44446595633573},{"lat":36.91686105774926,"lng":128.4444269059351},{"lat":36.916710783576484,"lng":128.44444258373287},{"lat":36.91642379930035,"lng":128.44453838623238},{"lat":36.91621722455165,"lng":128.44455336938395},{"lat":36.915973441317824,"lng":128.4445269884869},{"lat":36.91584676506182,"lng":128.44452542624958},{"lat":36.91572478051638,"lng":128.4445239218821},{"lat":36.91564989893818,"lng":128.4444996241788},{"lat":36.915514768351656,"lng":128.4443810867769},{"lat":36.915412200951806,"lng":128.44429801250845},{"lat":36.91531418586982,"lng":128.44423252518678},{"lat":36.91520669443577,"lng":128.44417860826547},{"lat":36.91514584147527,"lng":128.44416032753043},{"lat":36.91506617521323,"lng":128.44414765842592},{"lat":36.91494419063842,"lng":128.4441461547027},{"lat":36.914864431492035,"lng":128.44414517150395},{"lat":36.914572662780344,"lng":128.4442526009331},{"lat":36.9144228994597,"lng":128.44420400688406},{"lat":36.91420735922245,"lng":128.4441662891022},{"lat":36.914071624559334,"lng":128.44412371182997},{"lat":36.91395465673711,"lng":128.44408136603062},{"lat":36.91383736385254,"lng":128.44407992030258},{"lat":36.9137249019865,"lng":128.4440610038924},{"lat":36.9135425751306,"lng":128.44397694906533},{"lat":36.91335105047366,"lng":128.44386940776764},{"lat":36.913247925567376,"lng":128.4438564502326},{"lat":36.9131351851044,"lng":128.443872591085},{"lat":36.91305105917654,"lng":128.44383065090028},{"lat":36.91299508353036,"lng":128.44378905766536},{"lat":36.912939850526364,"lng":128.44365398000483},{"lat":36.91288461736551,"lng":128.44351890253657},{"lat":36.912829384047775,"lng":128.4433838252606},{"lat":36.91274600026869,"lng":128.44324840152237},{"lat":36.91269531919128,"lng":128.44313091073718},{"lat":36.912659594355276,"lng":128.44290258094324},{"lat":36.91264328503692,"lng":128.44259268367966},{"lat":36.91262107809482,"lng":128.44243464053412},{"lat":36.91258893133413,"lng":128.44234659511682},{"lat":36.91254321912533,"lng":128.4421941063486},{"lat":36.91250192042751,"lng":128.4420767319592},{"lat":36.91243210064662,"lng":128.44200575347452},{"lat":36.91238532244813,"lng":128.44198764826234},{"lat":36.91234783502385,"lng":128.44198134394242},{"lat":36.91227694957528,"lng":128.4420447485449},{"lat":36.912110283303434,"lng":128.44235239316737},{"lat":36.911982494433445,"lng":128.44249105977656},{"lat":36.91172682348069,"lng":128.44278007698912},{"lat":36.911599776106165,"lng":128.4428252593195},{"lat":36.91140267753768,"lng":128.4428286766044},{"lat":36.91110231476801,"lng":128.4428366660936},{"lat":36.910768785338185,"lng":128.4428851496318},{"lat":36.91064652238444,"lng":128.44291870379485},{"lat":36.910533781988335,"lng":128.44293484556601},{"lat":36.910388756048306,"lng":128.4428804719787},{"lat":36.91027188039672,"lng":128.4428264450707},{"lat":36.91020210738493,"lng":128.4427496254502},{"lat":36.910099585003216,"lng":128.44266071669404},{"lat":36.910034271804,"lng":128.4426131679314},{"lat":36.90995938971211,"lng":128.44258887401472},{"lat":36.90987020066336,"lng":128.44259361970475},{"lat":36.90970561956654,"lng":128.4426383394618},{"lat":36.909573834133376,"lng":128.4426893057006},{"lat":36.90944743584383,"lng":128.44265269176958},{"lat":36.909391366993745,"lng":128.44262278642438},{"lat":36.90923705013364,"lng":128.44255661382954},{"lat":36.90900334477521,"lng":128.44244272038284},{"lat":36.90881715895797,"lng":128.44225345266673},{"lat":36.908686624823424,"lng":128.44214667263327},{"lat":36.908630694829,"lng":128.44209924060132},{"lat":36.90851358710008,"lng":128.44207442840462},{"lat":36.90835379054577,"lng":128.44210752138386},{"lat":36.90810043752868,"lng":128.4421044057834},{"lat":36.907969254619815,"lng":128.44207942068587},{"lat":36.90757138472079,"lng":128.4419576692552},{"lat":36.9071789937455,"lng":128.44173665695578},{"lat":36.90690301561674,"lng":128.4416280925385},{"lat":36.90664998664692,"lng":128.44158408255717},{"lat":36.90654727804639,"lng":128.44151854875523},{"lat":36.9064729975414,"lng":128.44141830730035},{"lat":36.906412699538684,"lng":128.4413299235458},{"lat":36.90616974819028,"lng":128.4411983961232},{"lat":36.90611827806672,"lng":128.4411802353299},{"lat":36.90601064608326,"lng":128.44114385618587},{"lat":36.90597798913344,"lng":128.44112008374142},{"lat":36.90590393964947,"lng":128.44099063218036},{"lat":36.905653408681566,"lng":128.4406311445464},{"lat":36.90532532436278,"lng":128.44028823583793},{"lat":36.90511728229525,"lng":128.44019219855318},{"lat":36.905035870556176,"lng":128.44010355827933},{"lat":36.905005975300945,"lng":128.44002723573402},{"lat":36.90499772432019,"lng":128.43988398717332},{"lat":36.90500099452594,"lng":128.4397671723191},{"lat":36.905011417729874,"lng":128.43963583830455},{"lat":36.90501222632177,"lng":128.43953360010542},{"lat":36.90501285003256,"lng":128.4394547306347},{"lat":36.90499696024982,"lng":128.43938734419717},{"lat":36.90495305863036,"lng":128.43930208613727},{"lat":36.90490151889857,"lng":128.43929269018025},{"lat":36.90479353984521,"lng":128.43930013054077},{"lat":36.904584804089744,"lng":128.43929172888258},{"lat":36.90447703288608,"lng":128.43927287958203},{"lat":36.90436967735995,"lng":128.4392014511278},{"lat":36.90431342279101,"lng":128.43919491887385},{"lat":36.90418191580517,"lng":128.43921083496318},{"lat":36.9040877579037,"lng":128.43925057954516},{"lat":36.90396098882555,"lng":128.43926071091065},{"lat":36.90386255487544,"lng":128.43924781894555},{"lat":36.903764767507795,"lng":128.43915313777927},{"lat":36.90370892855864,"lng":128.43909402686387},{"lat":36.903659766644516,"lng":128.43878376405982},{"lat":36.90365130641401,"lng":128.4386668074834},{"lat":36.9036708118396,"lng":128.4385735640736},{"lat":36.90374220312615,"lng":128.43844590020134},{"lat":36.90377146098026,"lng":128.43830603481308},{"lat":36.90373972616316,"lng":128.43816542252006},{"lat":36.903731403708505,"lng":128.43803093961313},{"lat":36.903732095588516,"lng":128.4379433082947},{"lat":36.903765675645346,"lng":128.4378502368696},{"lat":36.9038372045011,"lng":128.43770504586115},{"lat":36.903861585335655,"lng":128.43758849098307},{"lat":36.90385317003108,"lng":128.4374656921064},{"lat":36.90379802164725,"lng":128.43731895092347},{"lat":36.90371495310479,"lng":128.4371426551999},{"lat":36.903655112580665,"lng":128.43699585713378},{"lat":36.90358984299372,"lng":128.4369424751922},{"lat":36.903519697360785,"lng":128.43691240426944},{"lat":36.90342130917654,"lng":128.43689367333644},{"lat":36.90328069538569,"lng":128.4368744261629},{"lat":36.90319629025199,"lng":128.4368675515345},{"lat":36.90313065205102,"lng":128.43686090638116},{"lat":36.90291575362152,"lng":128.43674142707528},{"lat":36.90281299608945,"lng":128.43668174503048},{"lat":36.902668012914575,"lng":128.43662154700758},{"lat":36.90262132585246,"lng":128.43659176349166},{"lat":36.902551318270255,"lng":128.4365441672866},{"lat":36.902485910299575,"lng":128.4365083125011},{"lat":36.902406196861534,"lng":128.43650149570692},{"lat":36.90237321656481,"lng":128.43651862028068},{"lat":36.90229764222473,"lng":128.4365819646017},{"lat":36.90227363087453,"lng":128.43665178162198},{"lat":36.90225417303242,"lng":128.43673918188395},{"lat":36.902244236794125,"lng":128.436809170892},{"lat":36.90224303898546,"lng":128.43696106227554},{"lat":36.90222348876159,"lng":128.43706014636825},{"lat":36.90219455498774,"lng":128.43715911564703},{"lat":36.902141932020456,"lng":128.43728700775517},{"lat":36.902070864643576,"lng":128.43737377636464},{"lat":36.90173246056997,"lng":128.43744558922697},{"lat":36.90152528669567,"lng":128.4375365344834},{"lat":36.90114727366876,"lng":128.4378707720279},{"lat":36.900982048347295,"lng":128.43799728358397},{"lat":36.90084575744826,"lng":128.4380248274704},{"lat":36.90070932816385,"lng":128.43806989683614},{"lat":36.900628922893645,"lng":128.4381507063854},{"lat":36.900505830611856,"lng":128.4382894171942},{"lat":36.90040095136419,"lng":128.43849845937564},{"lat":36.900311346943,"lng":128.4385557859183},{"lat":36.900213051280645,"lng":128.43852537011733},{"lat":36.90019534567429,"lng":128.43839077847414},{"lat":36.900212880676264,"lng":128.4379528143902},{"lat":36.90019794069832,"lng":128.4374677137269},{"lat":36.90018263015029,"lng":128.43702934776167},{"lat":36.900169983112754,"lng":128.43684807929543},{"lat":36.90015867131881,"lng":128.43649739816652},{"lat":36.90016097337411,"lng":128.4362053072498},{"lat":36.90016244631279,"lng":128.43601836904566},{"lat":36.90018429627612,"lng":128.43562719626806},{"lat":36.90023535299369,"lng":128.43510200479474},{"lat":36.90021350341658,"lng":128.4348972546791},{"lat":36.90016713764503,"lng":128.4348265804413},{"lat":36.900073532696446,"lng":128.43479622669642},{"lat":36.89997505214457,"lng":128.43478918302583},{"lat":36.8998434995957,"lng":128.43481094774728},{"lat":36.899659648390646,"lng":128.43491970957461},{"lat":36.899399993623234,"lng":128.43512102317493},{"lat":36.89927727269953,"lng":128.4352130027226},{"lat":36.899164487026546,"lng":128.43523499556935},{"lat":36.899071479930306,"lng":128.43512869916628}]]}},
    {"attributes":{"FID":0,"PMNTN_SN":32656,"MNTN_CODE":"438001301","MNTN_NM":"소백산_비로봉","PMNTN_NM":"어의곡리구간","PMNTN_MAIN":" ","PMNTN_LT":3.54,"PMNTN_DFFL":"쉬움","PMNTN_UPPL":62,"PMNTN_GODN":44,"PMNTN_MTRQ":" ","PMNTN_CNRL":" ","PMNTN_CLS_":" ","PMNTN_RISK":" ","PMNTN_RECO":" ","DATA_STDR_":"2016-12-31","MNTN_ID":"438001301"},"geometry":{"paths":[[{"lat":36.95792087430094,"lng":128.47875547508974},{"lat":36.957842673769406,"lng":128.4787169114223},{"lat":36.957815728583306,"lng":128.4785703974686},{"lat":36.95782229905092,"lng":128.4783424577387},{"lat":36.95784696136981,"lng":128.47819660410204},{"lat":36.95784840611478,"lng":128.47802121958733},{"lat":36.957826873867575,"lng":128.47778707360237},{"lat":36.957772932879394,"lng":128.47749989260424},{"lat":36.95767226729227,"lng":128.47718872790583},{"lat":36.9576633651341,"lng":128.47713014662125},{"lat":36.957693391009656,"lng":128.47690250683155},{"lat":36.95765299382608,"lng":128.476679814183},{"lat":36.9575276659898,"lng":128.47651450472438},{"lat":36.95744901391884,"lng":128.4763790254232},{"lat":36.95739396406781,"lng":128.47622630750925},{"lat":36.95733388597098,"lng":128.4761144527319},{"lat":36.957278451348635,"lng":128.47600850411814},{"lat":36.957232351854614,"lng":128.47590852150847},{"lat":36.95717686899935,"lng":128.4758084192854},{"lat":36.95712143409609,"lng":128.47570247110747},{"lat":36.95704196448272,"lng":128.47566637693552},{"lat":36.95677191479134,"lng":128.47541152410895},{"lat":36.956627338385,"lng":128.47530443992557},{"lat":36.95657673868846,"lng":128.47518101452556},{"lat":36.9565446173726,"lng":128.4750929048994},{"lat":36.95651244798617,"lng":128.47501064140002},{"lat":36.956461559984376,"lng":128.47492229267547},{"lat":36.956391617379914,"lng":128.4748687811176},{"lat":36.95629816855693,"lng":128.47482081667872},{"lat":36.956218842622484,"lng":128.47476718572958},{"lat":36.95612548973057,"lng":128.47470752947754},{"lat":36.95605549903285,"lng":128.47465986437558},{"lat":36.95599498756148,"lng":128.4746006269127},{"lat":36.95593945557611,"lng":128.47450637326472},{"lat":36.95589316287097,"lng":128.4744297773312},{"lat":36.95581479612989,"lng":128.47425922704375},{"lat":36.955778126351376,"lng":128.47415352091414},{"lat":36.955750887714984,"lng":128.47404208839737},{"lat":36.95572422435341,"lng":128.4738605040118},{"lat":36.95565997964136,"lng":128.47368428787829},{"lat":36.95559621394012,"lng":128.4734496121717},{"lat":36.95536445896146,"lng":128.47310171410746},{"lat":36.9552484134225,"lng":128.47294822672637},{"lat":36.955047774414716,"lng":128.4728112034633},{"lat":36.95494053710581,"lng":128.47272798775026},{"lat":36.9548518747625,"lng":128.47266839466562},{"lat":36.9547678561456,"lng":128.47261470731027},{"lat":36.95467454997612,"lng":128.47254920891578},{"lat":36.95459086643964,"lng":128.47245460043962},{"lat":36.95454921613455,"lng":128.47238391264602},{"lat":36.954507709392225,"lng":128.47229568721315},{"lat":36.9544754422788,"lng":128.47222511886315},{"lat":36.95439702441714,"lng":128.4720604198555},{"lat":36.95426704607193,"lng":128.47188921947398},{"lat":36.954214407860434,"lng":128.47172777204747},{"lat":36.95416126717387,"lng":128.4716277065798},{"lat":36.9540126172494,"lng":128.47144457734848},{"lat":36.95380879088092,"lng":128.47112335630348},{"lat":36.95358827997623,"lng":128.4708340806401},{"lat":36.95349592854243,"lng":128.47065166882456},{"lat":36.953343087040736,"lng":128.47040710244337},{"lat":36.953228858237985,"lng":128.47031795687928},{"lat":36.95318931360689,"lng":128.47027653029514},{"lat":36.9531335153678,"lng":128.47021443513538},{"lat":36.95307764545231,"lng":128.470161108766},{"lat":36.95303580269815,"lng":128.47011380679461},{"lat":36.95300114066672,"lng":128.47004905675053},{"lat":36.952966741235045,"lng":128.46995215491097},{"lat":36.95294847601083,"lng":128.4698905361214},{"lat":36.95293466367408,"lng":128.46985820579786},{"lat":36.95286948190799,"lng":128.46979599217286},{"lat":36.95277184047384,"lng":128.46968659604795},{"lat":36.95270081441748,"lng":128.46947814918826},{"lat":36.952673881477494,"lng":128.46932872523988},{"lat":36.95264929417294,"lng":128.46917933111766},{"lat":36.95263354134806,"lng":128.46909728229755},{"lat":36.952583364324475,"lng":128.46892125548823},{"lat":36.95253512747493,"lng":128.46879494758215},{"lat":36.95245409661757,"lng":128.46866237815104},{"lat":36.95225450123004,"lng":128.46839676491842},{"lat":36.95213095903528,"lng":128.468298736242},{"lat":36.952059001093865,"lng":128.46820428402188},{"lat":36.95202696977771,"lng":128.4681044910115},{"lat":36.95198560272556,"lng":128.4679987336101},{"lat":36.95193906742289,"lng":128.4679513741182},{"lat":36.95179668675625,"lng":128.46786187766034},{"lat":36.951579906529766,"lng":128.467689592106},{"lat":36.95126419644396,"lng":128.46756574944862},{"lat":36.95119889433787,"lng":128.46751815329307},{"lat":36.95110084588702,"lng":128.46745845052047},{"lat":36.95104471273028,"lng":128.46743727865737},{"lat":36.95098147065109,"lng":128.4674247862853},{"lat":36.95092986245637,"lng":128.46742413356037},{"lat":36.95085687987888,"lng":128.4674553648054},{"lat":36.95082636031412,"lng":128.46745790190985},{"lat":36.950777336072115,"lng":128.46742805069317},{"lat":36.950742577274426,"lng":128.46737499502066},{"lat":36.950708032736024,"lng":128.4672956340901},{"lat":36.95067813218374,"lng":128.46722217817714},{"lat":36.95064363515106,"lng":128.46713697176193},{"lat":36.950588049411934,"lng":128.4670485756976},{"lat":36.950499431612066,"lng":128.46698314702968},{"lat":36.950403585891316,"lng":128.46694101195928},{"lat":36.95035032202778,"lng":128.4668555687651},{"lat":36.95031366925922,"lng":128.4667469508517},{"lat":36.950281660459964,"lng":128.46664423792166},{"lat":36.95026152344989,"lng":128.46652413651105},{"lat":36.95025292516074,"lng":128.46642756570878},{"lat":36.950242123673306,"lng":128.4663134285224},{"lat":36.9502264401631,"lng":128.46622261445864},{"lat":36.95020369531811,"lng":128.46613463433758},{"lat":36.95017625875041,"lng":128.46604659501511},{"lat":36.95013723562793,"lng":128.4659408708902},{"lat":36.950100558237935,"lng":128.46583517649108},{"lat":36.95007068053326,"lng":128.46575879892876},{"lat":36.95004978201064,"lng":128.46573222728145},{"lat":36.95002409674618,"lng":128.4657172875656},{"lat":36.94996791570757,"lng":128.465701962859},{"lat":36.94992817923563,"lng":128.4656839226968},{"lat":36.94989081235746,"lng":128.46566298938603},{"lat":36.94984429983484,"lng":128.46561270983975},{"lat":36.94980470594587,"lng":128.46557713308164},{"lat":36.94977219706241,"lng":128.4655357996364},{"lat":36.94961630973687,"lng":128.46537598609615},{"lat":36.949555674591345,"lng":128.4653313748241},{"lat":36.9494996598086,"lng":128.46529559113},{"lat":36.949450872564505,"lng":128.46523651416865},{"lat":36.94937185082272,"lng":128.46514490211092},{"lat":36.94925318743405,"lng":128.46502355954965},{"lat":36.949136560997076,"lng":128.46494024275586},{"lat":36.949052776109696,"lng":128.46485734045825},{"lat":36.949008632800826,"lng":128.46480416879453},{"lat":36.94887840609607,"lng":128.46466222021874},{"lat":36.948843693497984,"lng":128.46460332162616},{"lat":36.948787987101056,"lng":128.4645295431746},{"lat":36.9487320670111,"lng":128.4644820694791},{"lat":36.948657427735334,"lng":128.46442851378026},{"lat":36.94857826292264,"lng":128.46435443990978},{"lat":36.94849895565776,"lng":128.46429790257346},{"lat":36.9484548832818,"lng":128.4642359634341},{"lat":36.948424885853875,"lng":128.4641742017675},{"lat":36.94838112188669,"lng":128.46407426732534},{"lat":36.94833043897083,"lng":128.463959630695},{"lat":36.94826819284621,"lng":128.46382438738044},{"lat":36.948219547156036,"lng":128.46374777599118},{"lat":36.948184715492204,"lng":128.46370349191},{"lat":36.948026598301794,"lng":128.46352904232793},{"lat":36.94791909321999,"lng":128.46347799713766},{"lat":36.94783298513297,"lng":128.4633921455205},{"lat":36.94775874838954,"lng":128.46328890558},{"lat":36.947702993722956,"lng":128.46322097453253},{"lat":36.9476587311147,"lng":128.46318241824673},{"lat":36.94760975312516,"lng":128.46314672563398},{"lat":36.94756522974009,"lng":128.4631403190875},{"lat":36.94750888237766,"lng":128.46314545565136},{"lat":36.94746170499032,"lng":128.46317701456874},{"lat":36.947426256751505,"lng":128.46320872112886},{"lat":36.94737673351641,"lng":128.46324025043666},{"lat":36.94734142750853,"lng":128.46325442081286},{"lat":36.94730863328471,"lng":128.4632481619164},{"lat":36.947259513069454,"lng":128.46323000553176},{"lat":36.947111939048824,"lng":128.46320184062313},{"lat":36.94705317472961,"lng":128.46321571560992},{"lat":36.946996661411866,"lng":128.46324131080684},{"lat":36.94689053000284,"lng":128.46331012572085},{"lat":36.946822097829966,"lng":128.46335895443232},{"lat":36.946777313639274,"lng":128.46338469715403},{"lat":36.9466292180119,"lng":128.46342083065178},{"lat":36.94652135718361,"lng":128.46341362641732},{"lat":36.94647451168521,"lng":128.46340426762637},{"lat":36.94640174348375,"lng":128.46340919715104},{"lat":36.94634068072828,"lng":128.46341719702318},{"lat":36.94629610992709,"lng":128.4634166357355},{"lat":36.9462397625449,"lng":128.46342177203127},{"lat":36.94617152002283,"lng":128.46344721910512},{"lat":36.946107826882944,"lng":128.46349026105676},{"lat":36.946051313504604,"lng":128.46351585574882},{"lat":36.945999610353375,"lng":128.46352689631792},{"lat":36.94590800434786,"lng":128.463540357244},{"lat":36.945865684520605,"lng":128.46355151595841},{"lat":36.945788272072996,"lng":128.46355054097208},{"lat":36.94574609452922,"lng":128.46354416391205},{"lat":36.94564299649837,"lng":128.46352825083898},{"lat":36.945520847246314,"lng":128.4635471728663},{"lat":36.945255910519954,"lng":128.46352629870867},{"lat":36.945124283078414,"lng":128.4635567928876},{"lat":36.94507739015173,"lng":128.46355327939915},{"lat":36.945000072548325,"lng":128.46354061405106},{"lat":36.94492479249789,"lng":128.463565971997},{"lat":36.94486136017464,"lng":128.46357686466257},{"lat":36.94480510763204,"lng":128.46357031040944},{"lat":36.94476766917338,"lng":128.46355814734503},{"lat":36.944718762395524,"lng":128.4635136881257},{"lat":36.944679072946414,"lng":128.46348980522222},{"lat":36.944587846315414,"lng":128.4634565046953},{"lat":36.94454329921264,"lng":128.4634530208409},{"lat":36.944482141593284,"lng":128.46347271082578},{"lat":36.94443268942017,"lng":128.46349547106433},{"lat":36.94437622345817,"lng":128.46351522007342},{"lat":36.94431267256978,"lng":128.4635407255669},{"lat":36.94423021273367,"lng":128.46358353007395},{"lat":36.94416417370878,"lng":128.46362654130925},{"lat":36.944110219564486,"lng":128.46362586176204},{"lat":36.94405638399393,"lng":128.46361056941225},{"lat":36.944011931750325,"lng":128.46359539526262},{"lat":36.94384554364233,"lng":128.4635728397451},{"lat":36.943586057284634,"lng":128.46345850379524},{"lat":36.943483433387016,"lng":128.46338414056873},{"lat":36.94343210956509,"lng":128.4633484202997},{"lat":36.94332903516494,"lng":128.4633295855076},{"lat":36.943139283472824,"lng":128.46329504535032},{"lat":36.94288391955132,"lng":128.46325091090148},{"lat":36.94278816707271,"lng":128.46319709483456},{"lat":36.9427133848497,"lng":128.46316107972717},{"lat":36.94267381381514,"lng":128.46312258511188},{"lat":36.942629835506494,"lng":128.46304896139978},{"lat":36.942599884754586,"lng":128.46298135992703},{"lat":36.94255578787203,"lng":128.46292234888705},{"lat":36.942534888639834,"lng":128.46289578065657},{"lat":36.94249318493579,"lng":128.4628309542318},{"lat":36.942449087975284,"lng":128.46277194336054},{"lat":36.9424048725249,"lng":128.46272754505006},{"lat":36.942360988722584,"lng":128.46264223183402},{"lat":36.94233786203648,"lng":128.46260102175438},{"lat":36.94223218010999,"lng":128.4623249499361},{"lat":36.94208567128316,"lng":128.46216527693116},{"lat":36.94178786659881,"lng":128.4618575636865},{"lat":36.94169720746539,"lng":128.4617541270953},{"lat":36.94162751875747,"lng":128.46166849090883},{"lat":36.94155967887227,"lng":128.4616442561707},{"lat":36.94147994415507,"lng":128.46164033132007},{"lat":36.9413579370804,"lng":128.4616417207302},{"lat":36.94111138776911,"lng":128.46166784966925},{"lat":36.94096615898612,"lng":128.46163971977512},{"lat":36.94070622090466,"lng":128.4615809211205},{"lat":36.94056321961049,"lng":128.4615674331813},{"lat":36.94031652830419,"lng":128.4616110966645},{"lat":36.94015945199199,"lng":128.46159743187937},{"lat":36.93998367997737,"lng":128.46157476410852},{"lat":36.93984328477573,"lng":128.46152915939675},{"lat":36.93974293437394,"lng":128.46146359914917},{"lat":36.939546664898856,"lng":128.4613646844134},{"lat":36.93922478455875,"lng":128.4611326718965},{"lat":36.938930793654286,"lng":128.46093316087044},{"lat":36.93861282389571,"lng":128.46079764870532},{"lat":36.93847702543888,"lng":128.46076379458967},{"lat":36.93826634931663,"lng":128.46070561944575},{"lat":36.93819907649402,"lng":128.46061125053467},{"lat":36.93809145164635,"lng":128.4605748279595},{"lat":36.93800252257185,"lng":128.46054740804138},{"lat":36.93794845014204,"lng":128.46056134246794},{"lat":36.937812486143045,"lng":128.46054794536587},{"lat":36.93761543583275,"lng":128.46054547204807},{"lat":36.93740030421917,"lng":128.46045801623282},{"lat":36.93713143094427,"lng":128.46034358314853},{"lat":36.937035582428976,"lng":128.4603014640794},{"lat":36.9369842339232,"lng":128.46026867125767},{"lat":36.936928122848606,"lng":128.46024458648736},{"lat":36.93687431035096,"lng":128.4602263757656},{"lat":36.936801707521724,"lng":128.46021085189363},{"lat":36.93674543104554,"lng":128.46020722321825},{"lat":36.9366984434115,"lng":128.46021540141098},{"lat":36.93660207504829,"lng":128.4602375728929},{"lat":36.93645137435483,"lng":128.46030582370972},{"lat":36.93620667469651,"lng":128.46039335261506},{"lat":36.93602768206209,"lng":128.46047878305131},{"lat":36.935955079256566,"lng":128.4604632591303},{"lat":36.93583584327401,"lng":128.46041207945933},{"lat":36.935723432104254,"lng":128.46038728846983},{"lat":36.93565310422742,"lng":128.46038056086846},{"lat":36.9355991263236,"lng":128.46038280605984},{"lat":36.93553543423121,"lng":128.4604258448364},{"lat":36.935483494946034,"lng":128.46046610850337},{"lat":36.93542892620156,"lng":128.46054140948448},{"lat":36.935338980749535,"lng":128.46063964654417},{"lat":36.93530836667196,"lng":128.46065387491186},{"lat":36.93524472176002,"lng":128.46069106884866},{"lat":36.93520943963881,"lng":128.46070231606058},{"lat":36.93515067549874,"lng":128.46071619101923},{"lat":36.935091934995604,"lng":128.4607271437366},{"lat":36.934901638450214,"lng":128.46075982510675},{"lat":36.93477683623256,"lng":128.46081670855799},{"lat":36.93470373699212,"lng":128.46086255092624},{"lat":36.93465201034549,"lng":128.4608765140317},{"lat":36.934530192260894,"lng":128.46085452718307},{"lat":36.93445522000779,"lng":128.46084189598895},{"lat":36.93437569792011,"lng":128.4608116727609},{"lat":36.93429387726385,"lng":128.46077557576845},{"lat":36.93421442607131,"lng":128.46073658611394},{"lat":36.934151655741104,"lng":128.4606656586206}]]}},
  ];

  res.json(DUMMY_DATA);
});

/**
 * @desc  This function returns important spot's coordinates converted from 
 *        TM projection to GRS80 Projection(degrees).
 *        HTTP request URL = host:3000/spots/{mntCode}/{fid}
 * 
 * @param String req.params.mntCode   Mountain's serial code.
 * @param String req.params.fid       Feature's ID.
 * 
 * @var   Array   coordinateFilePath  Coordinate file path in local storage.
 * @var   Array   coordinateFiles     Coordinate file list in local storage.
 * @var   String  mntFileName         Selected file name.
 * @var   Array   coordinateFile      JSON Object in local storage.
 *                                    This contains short description that hiking path.
 * @var   Array   mntPaths            Coordinates list in local file.
 * 
 * @return  null
 *          HTTP Response = String    The String is formatted by JSON syntax.
 */
router.get('/spots/:mntCode/:fid?', function(req, res, next) {
  var mntCode = req.params.mntCode;
  var fid     = req.params.fid;

  var coordinateFilePath = `public/mountain/${mntCode}_geojson`;

  // Hiking path files path in local
  var coordinateFiles = fs.readdirSync(coordinateFilePath);
  
  var mntFileName;
  
  for (let idx in coordinateFiles) {
    let fileName = coordinateFiles[idx];

    if (fileName.match(/^PMNTN_SPOT_/)) {
      mntFileName = fileName;
    }
  }

  var coordinateFile = JSON.parse(fs.readFileSync(`${coordinateFilePath}/${mntFileName}`, 'utf8'));

  res.send(convert(coordinateFile['features'], fid));
});

/**
 * @function      This function returns safe spot's coordinates converted from 
 *                TM projection to GRS80 Projection(degrees).
 *                HTTP request URL = host:3000/paths/{mntCode}/{fid}
 * 
 * @param String  req.params.mntCode   Mountain's serial code.
 * @param String  req.params.fid       Feature's ID.
 * 
 * @var   Array   coordinateFilePath  Coordinate file path in local storage.
 * @var   Array   coordinateFiles     Coordinate file list in local storage.
 * @var   String  mntFileName         Selected file name.
 * @var   Array   coordinateFile      JSON Object in local storage.
 *                                    This contains short description that hiking path.
 * @var   Array   mntPaths            Coordinates list in local file.
 * 
 * @return  null
 *          HTTP Response = String    The String is formatted by JSON syntax.
 */
router.get('/safe-spot/:mntCode/:fid?', function(req, res, next) {
  var mntCode = req.params.mntCode;
  var fid     = req.params.fid;

  var coordinateFilePath = `public/mountain/${mntCode}_geojson`;
  // Hiking path files path in local
  var coordinateFiles = fs.readdirSync(coordinateFilePath);
  
  var mntFileName;
  
  for (let idx in coordinateFiles) {
    let fileName = coordinateFiles[idx];

    if (fileName.match(/^PMNTN_SAFE_SPOT_/)) {
      mntFileName = fileName;
    }
  }

  var coordinateFile = JSON.parse(fs.readFileSync(`${coordinateFilePath}/${mntFileName}`, 'utf8'));

  res.send(convert(coordinateFile['features'], fid));
});

/**
 * @author    bs Kwon <rnjs9957@gmail.com>
 * 
 * @desc      This function returns coordinate 
 *            that converted from PM projection to GRS80 projection(degrees).
 * 
 * @requires  proj4 (NPM Package)
 * 
 * @param     Array     features      Coordinate set provided by Korea Forest Service.
 * @param     Number    fid           Coordinate feature's ID in data set.
 * 
 * @constant  String    KTM_PROJ      K-TM projection = coordinate measure method that uses in Korea.
 * @constant  String    EPSG4019      GRS80(Geodetic Reference System) https://en.wikipedia.org/wiki/GRS_80
 * 
 * @return    Array                   Converted coordinate set.
 */
var convert = function(features, fid) {
  // KTM Projectrion Setting (Korean)
  const KTM_PROJ = '+proj=tmerc +lat_0=38 +lon_0=127 +k=1 +x_0=200000 +y_0=600000 +ellps=GRS80 +units=m +no_defs';
  // GRS80 Projection Setting
  const EPSG4019 = '+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs';

  for (let idx in features) {
    if (fid != undefined && fid != idx) continue;

    let x = parseFloat(features[idx]['geometry']['x']);
    let y = parseFloat(features[idx]['geometry']['y']);


    let convertedPosition = proj4(KTM_PROJ, EPSG4019).forward([x, y]);

    features[idx]['geometry'] = {
      lat: convertedPosition[1],
      lng: convertedPosition[0],
    };
  }

  if (fid == undefined) {
    return features;
  } else {
    return features[fid];
  }
}

module.exports = router;